@using QueflityMVC.Domain.Interfaces
@using QueflityMVC.Web.Common
@model QueflityMVC.Application.ViewModels.Message.UserConversationsVm
@inject IMessageDateTimeFormatter dateTimeFormatter
@inject IUserContext UserContext

@{
    ViewData["Title"] = "Messages";
}

@section Styles{
    <style>
    .conversation-wrapper {
        display: flex;
        height: 35vh;
    }
    .partial-view {
        width: 30%;
        border-right: 1px solid #ccc;
        padding: 15px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        position: relative;
    }
    .messages-view {
        width: 70%;
        padding: 15px;
        overflow-y: auto;
        height: 100%;
    }
    .partial-view .last-message-time {
        font-size: 0.9em;
        color: #666;
    }
    .arrow-link {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2em;
        color: #007bff;
        text-decoration: none;
    }
    .arrow-link:hover {
        text-decoration: underline;
    }
</style>

    <link href="@Url.Content("~/css/messages.css")" rel="stylesheet" type="text/css"/>
}

<input type="hidden" id="conversationsData" value="@Json.Serialize(Model.Conversations)"/>

@foreach (var conversationVm in Model.Conversations)
{
    <div class="row conversation-wrapper">
        <div class="partial-view">
            <h5>@conversationVm.Title</h5>
            <h7>About: <strong>@conversationVm.Product.Name</strong></h7>
            <div class="user-info">
                <p class="last-message-time">Last message: @dateTimeFormatter.FormatDateTime(conversationVm.Messages.Last().SentAt)</p>
            </div>
            <a href="/Conversations/Details/@conversationVm.Id" class="arrow-link">&rarr;</a>
        </div>
        <div class="messages-view">
            @{
                var containerId = $"messagesList{conversationVm.Id}";
            }
            <div class="messages-container" id="@containerId">
            </div>

        </div>
    </div>
}

@section Scripts{
    <script src="~/js/messages.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
        const conversationsData = document.getElementById("conversationsData").value;
        const conversations = JSON.parse(conversationsData);
        const currentUserId = "@UserContext.UserId";
        conversations.forEach(conversation=>{
            const messagesContainerId="messagesList"+conversation.id;
            const messagesContainer=$('#' +messagesContainerId);
            
            conversation.messages.forEach(message => {
                const messageDiv = createMessageDiv(message, currentUserId);
                messagesContainer.append(messageDiv);
            });
        });
            document.querySelectorAll('.messages-view').forEach(element => {
                element.scrollTop = element.scrollHeight;
            });
        });
    </script>
}